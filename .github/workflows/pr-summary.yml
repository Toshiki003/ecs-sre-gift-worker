name: PR Summary (Optional)

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  pr-summary:
    runs-on: ubuntu-latest
    if: ${{ vars.AI_ENABLED == 'true' }}
    env:
      LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          DIFF=$(git diff origin/${{ github.base_ref }}...HEAD -- . ':!*.lock' ':!package-lock.json' | head -c 10000)
          echo "diff<<DIFF_EOF" >> "$GITHUB_OUTPUT"
          echo "$DIFF" >> "$GITHUB_OUTPUT"
          echo "DIFF_EOF" >> "$GITHUB_OUTPUT"

      - name: Generate summary with LLM API
        uses: actions/github-script@v8
        env:
          LLM_API_BASE: ${{ vars.LLM_API_BASE || 'https://api.groq.com/openai/v1' }}
          LLM_MODEL: ${{ vars.LLM_MODEL || 'groq/compound' }}
          PR_DIFF: ${{ steps.diff.outputs.diff }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            if (!process.env.LLM_API_KEY) {
              core.info('LLM_API_KEY is not set, skipping summary generation');
              return;
            }

            const apiBase = process.env.LLM_API_BASE;
            const model = process.env.LLM_MODEL;

            const resp = await fetch(`${apiBase}/chat/completions`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${process.env.LLM_API_KEY}`,
              },
              body: JSON.stringify({
                model: model,
                messages: [
                  {
                    role: 'system',
                    content: 'You are a strict senior reviewer. Summarize the PR changes in Japanese for a GitHub PR description. Include: what changed, why, risk/impact, how to test, and security considerations. Keep it concise.'
                  },
                  {
                    role: 'user',
                    content: `PR Title: ${process.env.PR_TITLE}\n\nDiff:\n${process.env.PR_DIFF}`
                  }
                ],
                max_tokens: 4096,
              }),
            });

            const data = await resp.json();
            if (!resp.ok) {
              core.warning(`LLM API error: ${JSON.stringify(data)}`);
              return;
            }

            // Detect provider name from API base URL
            let provider = 'LLM API';
            if (apiBase.includes('generativelanguage.googleapis.com')) {
              provider = 'Gemini';
            } else if (apiBase.includes('api.openai.com')) {
              provider = 'OpenAI';
            } else if (apiBase.includes('api.groq.com')) {
              provider = 'Groq';
            }

            const summary = data?.choices?.[0]?.message?.content;
            if (!summary) {
              core.warning('LLM API returned an empty summary.');
              return;
            }

            const marker = '<!-- ai-pr-summary -->';
            const aiSummaryBody = `${marker}\n## AI PR Summary\n\n${summary}\n\n---\n*Generated by ${provider} (${model})*`;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.issue.number;

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number,
              per_page: 100,
            });

            const existing = comments.find((c) => typeof c.body === 'string' && c.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body: aiSummaryBody,
              });
              core.info(`Updated AI summary comment: ${existing.id}`);
            } else {
              const created = await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body: aiSummaryBody,
              });
              core.info(`Created AI summary comment: ${created.data.id}`);
            }
