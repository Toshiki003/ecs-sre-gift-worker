# Decision Log

実装中に発生した設計判断を記録するドキュメント。

---

## テンプレート

### YYYY-MM-DD: [トピック]

**決定**: [何を決めたか]

**理由**:
- [理由1]
- [理由2]

**代替案**: [検討した他の選択肢]
- 却下理由: [なぜ選ばなかったか]

---

## 実際の記録

### 2026-02-24: 要件・タスクを app/template の二系統へ分離

**決定**: `claude-ext/docs/` の要件・タスクを用途別に分離し、以下を標準構成とする。  
- アプリ実装用: `app-requirements.md` / `app-tasklist.md`  
- テンプレート保守用: `template-requirements.md` / `template-tasklist.md`  
- 互換ポインタ: `requirements.md` / `tasklist.md`

**理由**:
- テンプレート保守と複製先アプリ実装で要求されるコンテキストが異なり、単一ファイル運用だと衝突するため
- 「要件を書いたらすぐ実装開始」の導線を維持しつつ、テンプレート自体の品質統制も継続したいため
- Start-up Protocol を app優先 + templateフォールバックにすることで、通常運用と保守運用を両立できるため

**代替案**:
- **単一 `requirements.md` の章分離**
  - 却下理由: 更新時に誤編集しやすく、運用モード切替が曖昧になるため
- **アプリ要件のみ管理しテンプレ要件を廃止**
  - 却下理由: テンプレート保守時の受け入れ条件が消え、品質回帰を検知しづらくなるため

### 2026-02-24: `dev-template` 自体の要件を雛形から実体仕様へ移行

**決定**: `claude-ext/docs/requirements.md` と `claude-ext/docs/tasklist.md` のプレースホルダ運用を廃止し、`dev-template` の実体仕様・受け入れ条件・保守タスクを明文化する。

**理由**:
- `.claude/CLAUDE.md` の Start-up Protocol が `requirements.md` 参照を強制しており、雛形のままでは判断根拠として機能しないため
- 厳格レビューで「仕様未定義」が High 指摘となっており、運用上の最大リスクだったため
- 仕様・タスクを実体化することで、レビュー基準と更新優先度を一貫させられるため

**代替案**:
- **雛形を維持し、READMEのみで補足する**
  - 却下理由: 機械処理/レビュー時の一次情報が分散し、運用ルール（requirements中心）と矛盾するため
- **requirementsのみ更新し、tasklistは雛形のまま残す**
  - 却下理由: 進捗管理が抽象的なままとなり、改善タスクの優先順位付けに失敗しやすいため

### 2026-02-24: PRサマリ生成のLLMプロバイダー切り替え対応

**決定**: OpenAI互換エンドポイント方式を採用し、APIベースURL・モデル名・APIキーの3つをGitHub Variables/Secretsで切り替え可能にする。デフォルトはGroq（groq/compound）。

**理由**:
- GroqがOpenAI互換エンドポイント（`/openai/v1/chat/completions`）を提供しているため、既存のリクエスト形式をほぼそのまま流用できる
- 変更箇所が最小限（ベースURL・モデル名・Secret名の3点のみ）
- `vars.XXX || 'デフォルト値'` パターンにより、Groq利用時は `LLM_API_KEY` のSecret設定のみで動作する
- OpenAI/Gemini等への切り替えもVariableの変更だけで対応可能

**代替案**:
- **プロバイダーごとに分岐するswitch方式**: 各プロバイダー固有のSDK/APIフォーマットを個別実装
  - 却下理由: コード量が大幅に増え、新プロバイダー追加のたびにワークフロー修正が必要
- **OPENAI_API_KEYへのフォールバック維持**: 旧Secret名との後方互換を残す
  - 却下理由: テンプレートリポジトリのため既存リポジトリへの直接影響なし。設定の複雑化を避ける

### 2026-02-28: dependency-review.yml に continue-on-error を追加

**決定**: `dependency-review.yml` に `continue-on-error: true` を追加し、失敗時に警告メッセージで設定手順を案内するステップを追加する。READMEにも初期設定セクションを追加。

**理由**:
- テンプレートから新規作成した直後、Dependency Graphが未有効のため `Error: Forbidden` でPRがブロックされていた
- GitHubの仕様上、リポジトリ設定（Dependency Graph等）はテンプレートから継承されない
- 非機能要件「テンプレートから新規作成したリポジトリで、追加セットアップなしに基本フローが成立する」への対応
- 既存ワークフロー（`pr-summary.yml`/`codex-review-comment.yml`）の条件分岐パターンと一貫したアプローチ

**代替案**:
- **Branch Protectionのrequired checkから外す**: Dependency Reviewを必須チェックから除外する
  - 却下理由: Dependency Graph有効化後もレビューが任意扱いとなり、依存変更の安全性チェックが漏れるリスクがある

### 2026-03-01: 文書同期チェックCIの追加

**決定**: `.github/workflows/doc-sync-check.yml` を新設し、PRトリガーでドキュメント関連ファイル変更時に以下を自動検証する。
1. シェルスクリプト構文チェック（`bash -n`）
2. 主要ワークフロー4種の存在確認
3. LLM外部送信ポリシーのREADME/SECURITY両方での記載確認
4. READMEディレクトリ構成に記載された主要ファイルの存在確認

**理由**:
- `template-requirements.md` の検証チェックリスト（セクション6）の4項目を手動確認に依存していたため
- 運用ルール「仕様変更PRでは README / SECURITY / decision-log を同時更新する」の遵守を検出可能にするため
- `paths` フィルターにより、文書・スクリプト・ワークフロー変更時のみ実行し、無関係なPRでのCI負荷を回避

**代替案**:
- **pre-commit hookでローカル検証**: ローカルにフックをインストールする方式
  - 却下理由: テンプレートから複製した際にフック設定が自動継承されず、利用者側の追加セットアップが必要になるため
- **全PRで常時実行**: `paths` フィルターを設けない
  - 却下理由: コード変更のみのPRでも毎回実行され、CIリソースの無駄が生じるため
